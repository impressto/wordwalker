<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Worker Debug - WordWalker PWA</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #569cd6; margin-top: 30px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #0e4429; color: #3fb950; }
        .error { background: #3d1515; color: #f85149; }
        .warning { background: #4d3800; color: #d29922; }
        .info { background: #1c2c4d; color: #58a6ff; }
        button {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #2ea043; }
        button.danger { background: #da3633; }
        button.danger:hover { background: #b62324; }
        pre {
            background: #0d1117;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            border: 1px solid #30363d;
        }
        .cache-item { 
            padding: 5px; 
            margin: 2px 0; 
            background: #161b22; 
            border-left: 3px solid #238636;
            font-size: 11px;
            word-break: break-all;
        }
        .cache-item.missing {
            border-left-color: #f85149;
            background: #2d1515;
        }
        #log {
            max-height: 400px;
            overflow-y: auto;
            background: #0d1117;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #30363d;
        }
        .log-entry { margin: 5px 0; font-size: 12px; }
        .log-sw { color: #3fb950; }
        .log-cache { color: #58a6ff; }
        .log-error { color: #f85149; }
        .critical-files {
            background: #161b22;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .file-check { padding: 3px 0; }
        .file-check.ok { color: #3fb950; }
        .file-check.fail { color: #f85149; }
    </style>
</head>
<body>
    <h1>üîç Service Worker Debug Tool - WordWalker</h1>
    <p>Use this page to debug the WordWalker PWA service worker and offline functionality</p>
    <div class="status info" style="margin: 10px 0;">
        ‚ÑπÔ∏è If no service worker is registered, click <strong>"Register Service Worker"</strong> below, 
        or visit the <a href="/wordwalker/" style="color: #58a6ff;">main app</a> first.
    </div>

    <h2>üìä Service Worker Status</h2>
    <div id="swStatus"></div>

    <h2>üéÆ Actions</h2>
    <button onclick="registerSW()">Register Service Worker</button>
    <button onclick="unregisterSW()" class="danger">Unregister Service Worker</button>
    <button onclick="updateSW()">Check for Updates</button>
    <button onclick="clearCaches()" class="danger">Clear All Caches</button>
    <button onclick="testOffline()">Test Offline Mode</button>
    <button onclick="checkCriticalFiles()">Check Critical Files</button>
    <button onclick="location.href='/wordwalker/'">Go to WordWalker App</button>

    <h2>üîç Critical Files Check</h2>
    <div id="criticalFiles"></div>

    <h2>üíæ Cached Files</h2>
    <div id="cacheList"></div>

    <h2>üìù Console Log</h2>
    <button onclick="document.getElementById('log').innerHTML = ''">Clear Log</button>
    <div id="log"></div>

    <script>
        const CRITICAL_FILES = [
            '/wordwalker/',
            '/wordwalker/index.php',
            '/wordwalker/dist/index.html',
            '/wordwalker/dist/manifest.json',
            '/wordwalker/dist/assets/index.js',
            '/wordwalker/dist/assets/vendor.js',
            '/wordwalker/dist/assets/index.css',
            '/wordwalker/dist/images/walkers/walker-default.png',
            '/wordwalker/dist/images/path.png',
            '/wordwalker/dist/images/grass.png',
        ];

        const log = (message, type = 'info') => {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.insertBefore(entry, logDiv.firstChild);
        };

        // Override console to capture logs
        const originalLog = console.log;
        const originalError = console.error;
        console.log = function(...args) {
            originalLog.apply(console, args);
            log(args.join(' '), 'sw');
        };
        console.error = function(...args) {
            originalError.apply(console, args);
            log(args.join(' '), 'error');
        };

        async function checkSWStatus() {
            const statusDiv = document.getElementById('swStatus');
            
            if (!('serviceWorker' in navigator)) {
                statusDiv.innerHTML = '<div class="status error">‚ùå Service Workers not supported in this browser</div>';
                return;
            }

            const registration = await navigator.serviceWorker.getRegistration('/wordwalker/');
            
            if (registration) {
                let status = '<div class="status success">‚úÖ Service Worker is registered</div>';
                status += `<div class="status info">üìç Scope: ${registration.scope}</div>`;
                
                if (registration.active) {
                    status += `<div class="status success">‚úÖ Active worker: ${registration.active.scriptURL}</div>`;
                    status += `<div class="status info">State: ${registration.active.state}</div>`;
                }
                if (registration.installing) {
                    status += `<div class="status warning">‚è≥ Installing worker...</div>`;
                }
                if (registration.waiting) {
                    status += `<div class="status warning">‚è≥ Worker waiting to activate (refresh to activate)</div>`;
                }
                
                statusDiv.innerHTML = status;
                log('Service worker status checked', 'sw');
            } else {
                statusDiv.innerHTML = '<div class="status warning">‚ö†Ô∏è No service worker registered</div>';
                log('No service worker found', 'error');
            }
        }

        async function registerSW() {
            try {
                log('Attempting to register service worker...', 'sw');
                log('Service Worker URL: service-worker.js', 'sw');
                log('Scope: /wordwalker/', 'sw');
                
                const registration = await navigator.serviceWorker.register('service-worker.js');
                log('‚úÖ Service worker registered successfully', 'sw');
                log(`Registration scope: ${registration.scope}`, 'sw');
                console.log('Registration:', registration);
                
                // Wait for installation to complete
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                await checkSWStatus();
                await listCaches();
                await checkCriticalFiles();
            } catch (error) {
                log(`‚ùå Registration failed: ${error.message}`, 'error');
                log(`Error details: ${error.stack}`, 'error');
                console.error('Full error:', error);
            }
        }

        async function unregisterSW() {
            const registration = await navigator.serviceWorker.getRegistration('/wordwalker/');
            if (registration) {
                await registration.unregister();
                log('‚úÖ Service worker unregistered', 'sw');
                await checkSWStatus();
            } else {
                log('No service worker to unregister', 'error');
            }
        }

        async function updateSW() {
            const registration = await navigator.serviceWorker.getRegistration('/wordwalker/');
            if (registration) {
                await registration.update();
                log('Checked for service worker updates', 'sw');
                await checkSWStatus();
            } else {
                log('No service worker registered', 'error');
            }
        }

        async function clearCaches() {
            const cacheNames = await caches.keys();
            let count = 0;
            for (const name of cacheNames) {
                await caches.delete(name);
                log(`Deleted cache: ${name}`, 'cache');
                count++;
            }
            log(`‚úÖ Cleared ${count} cache(s)`, 'cache');
            await listCaches();
            await checkCriticalFiles();
        }

        async function checkCriticalFiles() {
            const criticalDiv = document.getElementById('criticalFiles');
            log('Checking critical files...', 'cache');
            
            let html = '<div class="critical-files">';
            html += '<h3>Essential files for offline mode:</h3>';
            
            const cacheNames = await caches.keys();
            let foundCount = 0;
            let missingCount = 0;
            
            for (const file of CRITICAL_FILES) {
                let found = false;
                
                for (const cacheName of cacheNames) {
                    const cache = await caches.open(cacheName);
                    const response = await cache.match(file);
                    if (response) {
                        found = true;
                        break;
                    }
                }
                
                if (found) {
                    html += `<div class="file-check ok">‚úÖ ${file}</div>`;
                    foundCount++;
                } else {
                    html += `<div class="file-check fail">‚ùå ${file}</div>`;
                    missingCount++;
                    log(`Missing critical file: ${file}`, 'error');
                }
            }
            
            html += '</div>';
            
            if (missingCount === 0) {
                html = '<div class="status success">‚úÖ All critical files are cached!</div>' + html;
                log(`‚úÖ All ${foundCount} critical files cached`, 'cache');
            } else {
                html = `<div class="status error">‚ùå ${missingCount} critical files missing!</div>` + html;
                log(`‚ùå ${missingCount} critical files missing`, 'error');
            }
            
            criticalDiv.innerHTML = html;
        }

        async function listCaches() {
            const cacheList = document.getElementById('cacheList');
            const cacheNames = await caches.keys();
            
            if (cacheNames.length === 0) {
                cacheList.innerHTML = '<div class="status warning">‚ö†Ô∏è No caches found</div>';
                return;
            }

            let html = '';
            let totalFiles = 0;
            
            for (const cacheName of cacheNames) {
                const cache = await caches.open(cacheName);
                const keys = await cache.keys();
                totalFiles += keys.length;
                
                html += `<h3>üì¶ ${cacheName} (${keys.length} files)</h3>`;
                html += '<div style="margin-left: 20px;">';
                
                // Check if critical files are in this cache
                for (const request of keys) {
                    const isCritical = CRITICAL_FILES.includes(request.url.replace(location.origin, ''));
                    const className = isCritical ? 'cache-item' : 'cache-item';
                    html += `<div class="${className}">${request.url}</div>`;
                }
                
                html += '</div>';
            }
            
            cacheList.innerHTML = html;
            log(`Listed ${cacheNames.length} cache(s) with ${totalFiles} total files`, 'cache');
        }

        async function testOffline() {
            log('Testing offline mode...', 'sw');
            
            const testUrls = [
                '/wordwalker/index.php',
                '/wordwalker/dist/assets/index.js',
                '/wordwalker/dist/assets/vendor.js',
                '/wordwalker/dist/images/walkers/walker-default.png'
            ];
            
            for (const url of testUrls) {
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        const source = response.headers.get('x-from-cache') ? 'cache' : 'network/cache';
                        log(`‚úÖ Can fetch ${url} (${source})`, 'sw');
                    } else {
                        log(`‚ö†Ô∏è Fetch ${url} returned status: ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`‚ùå Fetch ${url} failed: ${error.message}`, 'error');
                }
            }
        }

        // Initialize on load
        window.addEventListener('load', async () => {
            log('Debug page loaded', 'sw');
            await checkSWStatus();
            await listCaches();
            await checkCriticalFiles();
        });

        // Listen for service worker updates
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                log('üîÑ Controller changed - new service worker activated', 'sw');
                checkSWStatus();
            });
            
            navigator.serviceWorker.addEventListener('message', (event) => {
                log(`üì® Message from SW: ${JSON.stringify(event.data)}`, 'sw');
            });
        }
    </script>
</body>
</html>
